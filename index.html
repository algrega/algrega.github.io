<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Time Tracker v4 - Remote, Part-Time & Breaks</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- Base Variables & Theming --- */
        :root {
            --primary-hue: 260; /* Purple */
            --secondary-hue: 210; /* Blue */
            --accent-hue: 300; /* Magenta/Pinkish */
            --remote-hue: 180; /* Teal/Cyan for Remote indicator */
            --intermediate-hue: 35; /* Orange/Yellow for intermediate breaks */

            --primary-color: hsl(var(--primary-hue), 70%, 60%);
            --secondary-color: hsl(var(--secondary-hue), 80%, 55%);
            --accent-color: hsl(var(--accent-hue), 60%, 65%);
            --remote-color: hsl(var(--remote-hue), 60%, 55%);
            --intermediate-color: hsl(var(--intermediate-hue), 85%, 60%);

            --gradient-bg: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            --gradient-text: linear-gradient(90deg, var(--primary-color) 0%, var(--accent-color) 100%);

            --text-color-light: hsl(0, 0%, 98%);
            --text-color-dark: hsl(var(--primary-hue), 15%, 25%);
            --text-color-medium: hsl(var(--primary-hue), 10%, 45%);
            --text-color-muted: hsl(var(--primary-hue), 10%, 65%);

            --bg-color: hsl(var(--secondary-hue), 30%, 96%);
            --card-bg: hsl(0, 0%, 100%);
            --input-bg: hsl(var(--secondary-hue), 20%, 99%);
            --input-border: hsl(var(--secondary-hue), 20%, 88%);
            --input-focus-border: var(--secondary-color);
            --shadow-color: hsla(var(--primary-hue), 40%, 50%, 0.1);
            --shadow-hover-color: hsla(var(--primary-hue), 40%, 50%, 0.15);
            --shadow-active-color: hsla(var(--primary-hue), 40%, 50%, 0.1);

            --success-color: hsl(140, 60%, 45%);
            --info-color: hsl(190, 70%, 50%);
            --warning-color: hsl(35, 85%, 55%);
            --danger-color: hsl(0, 70%, 55%);

            --base-font-size: 16px;
            --border-radius-sm: 6px;
            --border-radius-md: 10px;
            --border-radius-lg: 16px;
            --transition-fast: 0.15s;
            --transition-medium: 0.3s;
            --transition-slow: 0.5s;

            --toggle-width: 48px;
            --toggle-height: 26px;
            --toggle-padding: 3px;
            --toggle-inactive-bg: hsl(var(--secondary-hue), 15%, 80%);
            --toggle-active-bg: var(--accent-color); /* Default active color */
            --toggle-remote-active-bg: var(--remote-color); /* Specific color for remote toggle? Keep accent for now */
            --toggle-thumb-color: white;
        }

        .dark-theme {
            --primary-hue: 265;
            --secondary-hue: 215;
            --accent-hue: 305;
            --remote-hue: 185;
            --intermediate-hue: 38;

            --primary-color: hsl(var(--primary-hue), 60%, 70%);
            --secondary-color: hsl(var(--secondary-hue), 70%, 65%);
            --accent-color: hsl(var(--accent-hue), 50%, 75%);
            --remote-color: hsl(var(--remote-hue), 55%, 65%);
            --intermediate-color: hsl(var(--intermediate-hue), 80%, 65%);

            --text-color-light: hsl(var(--primary-hue), 15%, 15%);
            --text-color-dark: hsl(0, 0%, 95%);
            --text-color-medium: hsl(var(--primary-hue), 10%, 75%);
            --text-color-muted: hsl(var(--primary-hue), 10%, 55%);

            --bg-color: hsl(var(--secondary-hue), 15%, 12%);
            --card-bg: hsl(var(--secondary-hue), 15%, 18%);
            --input-bg: hsl(var(--secondary-hue), 15%, 22%);
            --input-border: hsl(var(--secondary-hue), 10%, 35%);
            --input-focus-border: var(--secondary-color);
            --shadow-color: hsla(0, 0%, 0%, 0.2);
            --shadow-hover-color: hsla(0, 0%, 0%, 0.3);
            --shadow-active-color: hsla(0, 0%, 0%, 0.15);

            --success-color: hsl(140, 55%, 60%);
            --info-color: hsl(190, 65%, 65%);
            --warning-color: hsl(35, 75%, 65%);
            --danger-color: hsl(0, 65%, 65%);
            --toggle-inactive-bg: hsl(var(--secondary-hue), 10%, 40%);
            --toggle-active-bg: var(--accent-color);
            --toggle-remote-active-bg: var(--remote-color); /* Keep accent for now */
        }

        /* --- Global Styles & Resets --- */
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color-dark);
            line-height: 1.6;
            min-height: 100vh;
            padding: 25px;
            font-size: var(--base-font-size);
            transition: background-color var(--transition-medium) ease, color var(--transition-medium) ease;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container { max-width: 620px; margin: 20px auto; padding: 0 15px; } /* Increased width slightly */

        /* --- Header --- */
        header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 30px; padding-bottom: 15px;
            border-bottom: 1px solid var(--input-border);
            transition: border-color var(--transition-medium);
        }
        h1 {
            font-size: calc(var(--base-font-size) * 1.5); font-weight: 600;
            display: flex; align-items: center; gap: 10px;
            background: var(--gradient-text); -webkit-background-clip: text; background-clip: text;
            color: transparent; -webkit-text-fill-color: transparent;
        }
        h1 .fas {
            font-size: calc(var(--base-font-size) * 1.4); opacity: 0.9;
            background: var(--gradient-text); -webkit-background-clip: text; background-clip: text;
            color: transparent; -webkit-text-fill-color: transparent;
        }
        .header-controls { display: flex; gap: 10px; }
        .icon-button {
            background: none; border: 1px solid var(--input-border); color: var(--text-color-medium);
            padding: 8px 10px; border-radius: var(--border-radius-md); cursor: pointer;
            transition: all var(--transition-fast) ease-out; font-size: calc(var(--base-font-size) * 0.9);
            display: flex; align-items: center; justify-content: center; gap: 8px;
            min-width: 40px; position: relative;
        }
        .icon-button:hover {
            background-color: var(--input-bg); color: var(--secondary-color); border-color: var(--secondary-color);
            transform: translateY(-1px); box-shadow: 0 2px 5px var(--shadow-color);
        }
        .icon-button:active { transform: translateY(0); background-color: color-mix(in srgb, var(--input-bg) 80%, black); box-shadow: none; }
        .icon-button .fas { font-size: calc(var(--base-font-size) * 1.1); transition: transform var(--transition-medium) ease; }
        .dark-theme #theme-toggle-btn .fa-moon { transform: rotate(360deg); }
        #theme-toggle-btn .fa-sun { transform: rotate(0deg); }
        .dark-theme #theme-toggle-btn .fa-sun { transform: rotate(360deg); }

        /* --- Cards --- */
        .card {
            background-color: var(--card-bg); border-radius: var(--border-radius-lg);
            box-shadow: 0 5px 15px var(--shadow-color); padding: 25px 30px;
            margin-bottom: 25px; overflow: hidden;
            transition: background-color var(--transition-medium), box-shadow var(--transition-medium), border-color var(--transition-medium), border-left-color var(--transition-medium);
            border: 1px solid transparent; border-left: 5px solid transparent; /* Prepare left border */
            position: relative;
        }
        .dark-theme .card { border-color: var(--input-border); border-left-color: transparent; } /* Reset left border in dark theme */

        /* --- Mode Active Indication --- */
        body.part-time-active #input-card { border-left-color: var(--accent-color); }
        body.remote-work-active #input-card { border-left-color: var(--remote-color); }

        /* Optional ::after indicators if preferred */
        body.part-time-active #part-time-label::after,
        body.remote-work-active #remote-work-label::after {
            content: "Attiva"; /* Generic "Active" */
            font-size: 75%; font-weight: 600; padding: 2px 6px; margin-left: 8px;
            border-radius: var(--border-radius-sm); color: var(--text-color-light);
            vertical-align: middle;
        }
        body.part-time-active #part-time-label::after { background-color: var(--accent-color); }
        body.remote-work-active #remote-work-label::after { background-color: var(--remote-color); }

        /* --- Form Elements --- */
        .form-group {
            margin-bottom: 20px; opacity: 0; transform: translateX(-10px);
            animation: slideFadeIn 0.4s ease forwards;
        }
        /* Adjust animation delays for new elements */
        #input-card .form-group:nth-child(1) { animation-delay: 0.1s; } /* Entry */
        #input-card .form-group:nth-child(2) { animation-delay: 0.18s; } /* Lunch Start */
        #input-card .form-group:nth-child(3) { animation-delay: 0.26s; } /* Lunch End */
        #intermediate-breaks-section { animation-delay: 0.34s; opacity: 0; transform: translateX(-10px); animation: slideFadeIn 0.4s ease forwards; } /* Intermediate Breaks Section */
        #input-card .form-group:nth-child(5) { animation-delay: 0.42s; } /* Part-Time Toggle */
        #input-card .form-group:nth-child(6) { animation-delay: 0.50s; } /* Remote Work Toggle */
        #input-card > button#calculate-btn { animation-delay: 0.58s; } /* Calculate button */

        label {
            display: block; margin-bottom: 8px; font-weight: 500;
            font-size: calc(var(--base-font-size) * 0.9); color: var(--text-color-medium);
            transition: color var(--transition-medium); display: flex; align-items: center; gap: 8px;
        }
        label .fas { color: var(--secondary-color); width: 16px; text-align: center; transition: color var(--transition-medium); opacity: 0.8; }

        input[type="time"] {
            width: 100%; padding: 12px 15px; font-size: var(--base-font-size);
            border: 1px solid var(--input-border); border-radius: var(--border-radius-md);
            background-color: var(--input-bg); color: var(--text-color-dark);
            transition: border-color var(--transition-fast), background-color var(--transition-medium), color var(--transition-medium), box-shadow var(--transition-fast);
            appearance: none; -webkit-appearance: none; -moz-appearance: none;
        }
        input[type="time"]:focus {
            outline: none; border-color: var(--input-focus-border);
            box-shadow: 0 0 0 3px color-mix(in srgb, var(--input-focus-border) 20%, transparent);
            background-color: var(--card-bg);
        }
        input[type="time"]::-webkit-calendar-picker-indicator {
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clock" viewBox="0 0 16 16"><path d="M8 3.5a.5.5 0 0 0-1 0V9a.5.5 0 0 0 .252.434l3.5 2a.5.5 0 0 0 .496-.868L8 8.71V3.5z"/><path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm7-8A7 7 0 1 1 1 8a7 7 0 0 1 14 0z"/></svg>') no-repeat center center;
            background-size: 16px 16px; opacity: 0.6; cursor: pointer; transition: opacity var(--transition-fast);
            filter: var(--dark-theme) invert(0.8);
        }
        input[type="time"]:hover::-webkit-calendar-picker-indicator { opacity: 0.9; }
        .dark-theme input[type="time"]::-webkit-calendar-picker-indicator { filter: invert(0.8); }

        /* --- Intermediate Breaks --- */
        #intermediate-breaks-section { margin-bottom: 20px; }
        #intermediate-breaks-section h3 {
            font-size: calc(var(--base-font-size) * 0.95); font-weight: 600; color: var(--intermediate-color);
            margin-bottom: 15px; display: flex; align-items: center; gap: 8px; border-bottom: 1px solid var(--input-border); padding-bottom: 8px;
        }
        #intermediate-breaks-container { display: flex; flex-direction: column; gap: 15px; margin-bottom: 15px; }
        .intermediate-break-row {
            display: flex; align-items: flex-end; gap: 10px; /* Align items to bottom for button placement */
            padding: 10px; border: 1px dashed var(--input-border); border-radius: var(--border-radius-md);
            background-color: color-mix(in srgb, var(--input-bg) 50%, transparent);
        }
        .intermediate-break-row > div { flex-grow: 1; } /* Make input groups take available space */
        .intermediate-break-row label { margin-bottom: 5px; font-size: calc(var(--base-font-size) * 0.85); gap: 6px;}
        .intermediate-break-row label .fas { width: 14px; color: var(--intermediate-color); opacity: 0.9;}
        .intermediate-break-row input[type="time"] { padding: 10px 12px; font-size: calc(var(--base-font-size) * 0.95); }
        .remove-intermediate-break-btn {
            background: none; border: 1px solid var(--input-border); color: var(--danger-color);
            padding: 8px 10px; border-radius: var(--border-radius-md); cursor: pointer;
            transition: all var(--transition-fast) ease-out; font-size: calc(var(--base-font-size) * 0.9);
            flex-shrink: 0; /* Prevent button shrinking */
            line-height: 1; /* Align icon better */
            opacity: 0.7;
        }
        .remove-intermediate-break-btn:hover {
            background-color: color-mix(in srgb, var(--danger-color) 10%, transparent); border-color: var(--danger-color);
            opacity: 1; transform: translateY(-1px);
        }
        #add-intermediate-break-btn {
            background: none; border: 1px dashed var(--secondary-color); color: var(--secondary-color);
            padding: 10px 15px; font-size: calc(var(--base-font-size) * 0.9);
            border-radius: var(--border-radius-md); cursor: pointer; width: 100%; font-weight: 500;
            transition: all var(--transition-fast) ease; margin-top: 5px;
            display: flex; align-items: center; justify-content: center; gap: 8px; opacity: 0.8;
        }
        #add-intermediate-break-btn:hover {
            background-color: color-mix(in srgb, var(--secondary-color) 10%, transparent);
            border-style: solid; opacity: 1;
        }

        /* --- Toggle Switch --- */
        .toggle-switch-label {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            font-weight: 500;
            font-size: calc(var(--base-font-size) * 0.9);
            color: var(--text-color-medium);
            gap: 10px;
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: var(--toggle-width);
            height: var(--toggle-height);
            flex-shrink: 0;
        }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--toggle-inactive-bg);
            border-radius: var(--toggle-height);
            transition: background-color var(--transition-medium);
        }
        .toggle-slider::before {
            position: absolute; content: "";
            height: calc(var(--toggle-height) - (2 * var(--toggle-padding)));
            width: calc(var(--toggle-height) - (2 * var(--toggle-padding)));
            left: var(--toggle-padding); bottom: var(--toggle-padding);
            background-color: var(--toggle-thumb-color); border-radius: 50%;
            transition: transform var(--transition-medium);
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        input:checked + .toggle-slider { background-color: var(--toggle-active-bg); } /* Default active */
        /* Optional: Different color for remote toggle */
        /* #remote-work-toggle:checked + .toggle-slider { background-color: var(--toggle-remote-active-bg); } */
        input:checked + .toggle-slider::before { transform: translateX(calc(var(--toggle-width) - var(--toggle-height))); }
        input:focus + .toggle-slider { box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent-color) 30%, transparent); }
        /* #remote-work-toggle:focus + .toggle-slider { box-shadow: 0 0 0 3px color-mix(in srgb, var(--remote-color) 30%, transparent); } */

        /* --- Buttons --- */
        button.main-action {
            background: var(--gradient-bg); color: var(--text-color-light); border: none;
            padding: 13px 20px; font-size: calc(var(--base-font-size) * 1.0);
            border-radius: var(--border-radius-md); cursor: pointer; width: 100%; font-weight: 600;
            transition: transform var(--transition-fast) ease, box-shadow var(--transition-fast) ease, opacity var(--transition-medium);
            margin-top: 15px; display: flex; align-items: center; justify-content: center; gap: 10px;
            position: relative; overflow: hidden; box-shadow: 0 4px 10px var(--shadow-color);
            /* Keep animation for consistency, adjust if needed */
            opacity: 0; transform: translateY(5px); animation: slideFadeIn 0.4s ease forwards;
        }
        /* Adjust animation delays for buttons in their respective cards */
        /* #calculate-btn delay set within .form-group section */
        #calculate-hours-btn { animation-delay: 0.4s; }

        button.main-action::before {
            content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
            background: linear-gradient(120deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.15) 50%, rgba(255,255,255,0) 100%);
            transition: left var(--transition-slow) ease-in-out; opacity: 0.7;
        }
        button.main-action:hover { transform: translateY(-2px) scale(1.01); box-shadow: 0 7px 15px var(--shadow-hover-color); opacity: 0.95; }
        button.main-action:hover::before { left: 100%; }
        button.main-action:active { transform: translateY(0) scale(0.99); box-shadow: 0 3px 8px var(--shadow-active-color); opacity: 0.9; }
        button.main-action .fas { margin-right: 2px; transition: transform 0.2s ease; }
        button.main-action:hover .fas { transform: rotate(-5deg) scale(1.05); }

        /* --- Result Cards & Items --- */
        .result-card, .actual-exit-card { display: none; opacity: 0; transform: translateY(10px); animation: resultFadeIn 0.5s ease forwards; }
        .result-card.show, .actual-exit-card.show { display: block; }
        .result-item {
            display: flex; justify-content: space-between; align-items: center; padding: 12px 5px;
            border-bottom: 1px solid var(--input-border); font-size: calc(var(--base-font-size) * 0.9);
            transition: border-color var(--transition-medium), background-color var(--transition-fast) ease;
            opacity: 0; transform: translateX(-10px); animation: slideFadeIn 0.4s ease forwards;
        }
        /* Adjust result item delays if needed */
        .result-card .result-item:nth-child(1) { animation-delay: 0.1s; } /* Lunch Duration */
        .result-card .result-item:nth-child(2) { animation-delay: 0.18s; } /* Meal Voucher */
        .result-card .result-item:nth-child(3) { animation-delay: 0.26s; } /* Lunch Bonus */
        .result-card .result-item:nth-child(4) { animation-delay: 0.34s; } /* Exit Time */
        .actual-exit-card .result-item:nth-child(1) { animation-delay: 0.1s; } /* Total Hours */
        .actual-exit-card .result-item:nth-child(2) { animation-delay: 0.18s; } /* Difference */
        .result-item:last-child { border-bottom: none; }
        .result-item:hover { background-color: color-mix(in srgb, var(--bg-color) 50%, var(--card-bg)); }
        .result-label { font-weight: 400; color: var(--text-color-medium); display: flex; align-items: center; gap: 10px; transition: color var(--transition-medium); }
        .result-label .fas { color: var(--secondary-color); width: 18px; text-align: center; transition: color var(--transition-medium); font-size: calc(var(--base-font-size) * 1.05); opacity: 0.8; }
        .result-value {
            font-weight: 600; color: var(--text-color-dark); padding: 4px 8px; border-radius: var(--border-radius-sm);
            background-color: color-mix(in srgb, var(--text-color-muted) 10%, transparent);
            transition: color var(--transition-medium), background-color var(--transition-medium);
            min-width: 50px; text-align: right;
        }
        .result-value.success { color: var(--success-color); background-color: color-mix(in srgb, var(--success-color) 15%, transparent); }
        .result-value.info { color: var(--info-color); background-color: color-mix(in srgb, var(--info-color) 15%, transparent); }
        .result-value.warning { color: var(--warning-color); background-color: color-mix(in srgb, var(--warning-color) 15%, transparent); }
        .dark-theme .result-value { background-color: color-mix(in srgb, var(--text-color-muted) 20%, transparent); }
        .dark-theme .result-value.success { background-color: color-mix(in srgb, var(--success-color) 25%, transparent); }
        .dark-theme .result-value.info { background-color: color-mix(in srgb, var(--info-color) 25%, transparent); }
        .dark-theme .result-value.warning { background-color: color-mix(in srgb, var(--warning-color) 25%, transparent); }
        .divider { margin: 15px 0; border-top: 1px dashed var(--input-border); transition: border-color var(--transition-medium); opacity: 0.6; }

        /* --- Rules Section --- */
        .rules-section {
            max-height: 0; opacity: 0; overflow: hidden;
            background-color: color-mix(in srgb, var(--card-bg) 95%, var(--bg-color));
            border-radius: var(--border-radius-lg); padding: 0 30px; margin-bottom: 0;
            border: 0px solid transparent; box-shadow: 0 5px 15px var(--shadow-color);
            transition: max-height var(--transition-medium) ease-in-out, padding var(--transition-medium) ease-in-out,
                        margin-bottom var(--transition-medium) ease-in-out, border-width var(--transition-medium) ease-in-out,
                        opacity var(--transition-medium) ease-in-out;
        }
        .rules-section.show {
            max-height: 1000px; opacity: 1; padding: 25px 30px; margin-bottom: 25px;
            border: 1px solid var(--input-border);
        }
        .rules-section h2 { font-size: calc(var(--base-font-size) * 1.1); font-weight: 600; margin-bottom: 15px; color: var(--primary-color); display: flex; align-items: center; gap: 8px; }
        .rules-section ul { list-style: none; padding-left: 5px; }
        .rules-section ul ul { margin-top: 8px; padding-left: 15px; } /* Indent nested list */
        .rules-section li { margin-bottom: 12px; font-size: calc(var(--base-font-size) * 0.9); color: var(--text-color-medium); position: relative; padding-left: 25px; }
        .rules-section li::before {
            content: "\f105"; font-family: "Font Awesome 6 Free"; font-weight: 900;
            position: absolute; left: 0; top: 1px; color: var(--accent-color);
            transition: color var(--transition-medium); font-size: calc(var(--base-font-size) * 0.95);
        }
        .rules-section strong { font-weight: 600; color: var(--text-color-dark); }
        .rules-section code { background-color: color-mix(in srgb, var(--input-border) 50%, transparent); padding: 2px 5px; border-radius: var(--border-radius-sm); font-size: 85%; color: var(--accent-color); }
        /* Add rule for intermediate breaks */
        .rules-section .intermediate-rule { color: var(--intermediate-color); }
        .rules-section .intermediate-rule strong { color: var(--intermediate-color); }
        .rules-section .intermediate-rule::before { color: var(--intermediate-color); }


        /* --- Animations --- */
        @keyframes slideFadeIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes resultFadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse-value { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        .result-value.updated { animation: pulse-value 0.4s ease-in-out; }

        /* --- Responsive --- */
        @media (max-width: 600px) {
            body { padding: 15px; }
            .container { margin: 10px auto; max-width: 100%; } /* Adjust max-width */
            h1 { font-size: calc(var(--base-font-size) * 1.3); gap: 8px;}
            h1 .fas { font-size: calc(var(--base-font-size) * 1.2); }
            .card { padding: 20px; }
            .rules-section.show { padding: 20px; }
            header { margin-bottom: 20px; padding-bottom: 10px; }
            button.main-action { padding: 12px 15px; font-size: var(--base-font-size); }
            .icon-button { padding: 7px 9px; font-size: calc(var(--base-font-size) * 0.85); min-width: 36px; }
            .result-label { gap: 8px; }
            .result-label .fas { width: 16px; font-size: var(--base-font-size); }
            .result-value { font-size: calc(var(--base-font-size) * 0.85); }
            .rules-section li { padding-left: 20px; }
            .rules-section { padding-left: 20px; padding-right: 20px; }
            .toggle-switch-label { flex-direction: column; align-items: flex-start; gap: 8px; } /* Stack toggle label on mobile */
            .toggle-switch { margin-top: 5px; }
            .intermediate-break-row { flex-direction: column; align-items: stretch; gap: 10px; padding: 15px; }
            .intermediate-break-row > div { width: 100%; }
            .remove-intermediate-break-btn { width: 100%; margin-top: 5px; padding: 10px; } /* Full width remove button */
        }

    </style>
</head>
<body class="">
    <div class="container">
        <header>
            <h1><i class="fas fa-stopwatch-20"></i> Time Tracker</h1>
            <div class="header-controls">
                <button id="rules-toggle-btn" class="icon-button" title="Mostra/Nascondi Regole">
                    <i class="fas fa-info-circle"></i>
                </button>
                <button id="theme-toggle-btn" class="icon-button" title="Cambia Tema">
                    <i class="fas fa-moon"></i>
                </button>
            </div>
        </header>

        <section class="rules-section card" id="rules-section">
            <h2><i class="fas fa-book-open"></i> Regole di Calcolo</h2>
            <ul>
                <li>Seleziona la modalità operativa: <strong>Full-Time</strong> (standard), <strong>Part-Time</strong> (6h) o <strong>Lavoro da Remoto</strong> (7h 12m, regole specifiche).</li>
                <li>La giornata lavorativa standard è di <strong>7 ore e 12 minuti</strong> (<code>7h 12m</code>) per Full-Time e Remoto.</li>
                <li>In <strong>Part-Time</strong>, la giornata lavorativa standard diventa di <strong>6 ore</strong> (<code>6h 00m</code>).</li>
                <li class="intermediate-rule"><strong>Pause Intermedie:</strong> Puoi aggiungere una o più uscite/rientri intermedi. La durata totale di queste pause viene aggiunta al calcolo dell'orario di uscita previsto e sottratta dalle ore lavorate effettive.</li>
                <li><strong>Pausa Pranzo (Full/Part-Time):</strong> Se inserisci orari di pausa pranzo:
                    <ul>
                        <li>Durata minima calcolata: <strong>30 minuti</strong>.</li>
                        <li>Se pausa effettiva > 30 min, si ottiene un <strong>Bonus</strong> (tempo eccedente fino a max <strong>10 minuti</strong>) sottratto dal totale ore da lavorare.</li>
                        <li>Buono pasto: Considerato valido se la pausa viene effettuata.</li>
                    </ul>
                 </li>
                 <li><strong>Pausa Pranzo (Lavoro da Remoto):</strong> Se inserisci orari di pausa pranzo:
                    <ul>
                        <li>Durata minima calcolata: <strong>30 minuti</strong>.</li>
                        <li><strong>Nessun Bonus</strong> applicato, indipendentemente dalla durata.</li>
                        <li>Buono pasto: Valido solo se la durata <strong>effettiva</strong> della pausa è >= <strong>30 minuti</strong>.</li>
                    </ul>
                </li>
                <li>Se non inserisci gli orari di pausa pranzo, non viene applicata nessuna pausa, bonus o buono pasto.</li>
                <li><strong>Orario di Uscita Previsto:</strong> <code>Ingresso + Durata Standard + Durata Pausa Pranzo Calcolata (min 30m) + Durata Totale Pause Intermedie - Bonus Pausa Pranzo (solo Full/Part-Time, max 10m)</code>.</li>
                <li><strong>Totale Ore Lavorate:</strong> <code>Uscita Effettiva - Ingresso - Durata Pausa Pranzo Effettiva (durante orario lavoro) - Durata Totale Pause Intermedie (durante orario lavoro) + Bonus Pausa Pranzo (solo Full/Part-Time)</code>.</li>
                <li>La <strong>Differenza dal previsto</strong> confronta le ore lavorate con la durata standard della modalità selezionata.</li>
            </ul>
        </section>

        <div class="card" id="input-card">
            <div class="form-group">
                <label for="entry-time"><i class="fas fa-right-to-bracket"></i>Orario di ingresso:</label>
                <input type="time" id="entry-time" required>
            </div>
            <div class="form-group">
                <label for="lunch-start"><i class="fas fa-utensils"></i>Uscita per pausa pranzo:</label>
                <input type="time" id="lunch-start">
            </div>
            <div class="form-group">
                <label for="lunch-end"><i class="fas fa-person-walking-arrow-right"></i>Rientro dalla pausa pranzo:</label>
                <input type="time" id="lunch-end">
            </div>

            <!-- Intermediate Breaks Section -->
            <div id="intermediate-breaks-section">
                <h3><i class="fas fa-person-walking-luggage"></i> Pause Intermedie</h3>
                <div id="intermediate-breaks-container">
                    <!-- Intermediate break rows will be added here by JS -->
                </div>
                <button id="add-intermediate-break-btn" type="button"><i class="fas fa-plus-circle"></i>Aggiungi Pausa Intermedia</button>
            </div>

            <div class="form-group">
                 <label class="toggle-switch-label" for="part-time-toggle">
                     <span id="part-time-label">Modalità Part-Time (6h)</span>
                     <div class="toggle-switch">
                         <input type="checkbox" id="part-time-toggle">
                         <span class="toggle-slider"></span>
                     </div>
                 </label>
            </div>
            <div class="form-group">
                 <label class="toggle-switch-label" for="remote-work-toggle">
                     <span id="remote-work-label">Lavoro da Remoto</span>
                     <div class="toggle-switch">
                         <input type="checkbox" id="remote-work-toggle">
                         <span class="toggle-slider"></span>
                     </div>
                 </label>
            </div>
            <button id="calculate-btn" class="main-action"><i class="fas fa-calculator"></i>Calcola Orario di Uscita</button>
        </div>

        <div class="card result-card" id="result-card">
            <!-- Result items remain the same, values will reflect intermediate breaks -->
            <div class="result-item">
                <span class="result-label"><i class="fas fa-clock"></i>Durata pausa pranzo (effettiva):</span>
                <span class="result-value info" id="lunch-duration">--:--</span>
            </div>
             <div class="result-item">
                <span class="result-label"><i class="fas fa-ticket-alt"></i>Buono Pasto (pranzo):</span>
                <span class="result-value" id="meal-voucher-status">--</span>
            </div>
            <div class="result-item">
                <span class="result-label"><i class="fas fa-gift"></i>Bonus pausa pranzo:</span>
                <span class="result-value" id="lunch-bonus">--</span>
            </div>
            <div class="result-item">
                <span class="result-label"><i class="fas fa-right-from-bracket"></i>Orario previsto di uscita:</span>
                <span class="result-value success" id="exit-time">--:--</span>
            </div>

            <div class="divider"></div>

            <div class="form-group">
                <label for="actual-exit-time"><i class="fas fa-check-double"></i>Orario effettivo di uscita:</label>
                <input type="time" id="actual-exit-time">
            </div>
            <button id="calculate-hours-btn" class="main-action"><i class="fas fa-hourglass-half"></i>Calcola Ore Lavorate</button>
        </div>

        <div class="card actual-exit-card" id="actual-exit-card">
             <!-- Actual results remain the same, values will reflect intermediate breaks -->
            <div class="result-item">
                <span class="result-label"><i class="fas fa-briefcase"></i>Totale ore lavorate:</span>
                <span class="result-value" id="total-hours">--:--</span>
            </div>
            <div class="result-item">
                <span class="result-label"><i class="fas fa-arrows-left-right"></i>Differenza dal previsto (<span id="target-hours-label">7h 12m</span>):</span>
                <span class="result-value" id="hours-difference">--:--</span>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // --- UI Elements ---
            const themeToggleButton = document.getElementById("theme-toggle-btn");
            const themeButtonIcon = themeToggleButton.querySelector('.fas');
            const rulesToggleButton = document.getElementById("rules-toggle-btn");
            const rulesSection = document.getElementById("rules-section");
            const partTimeToggle = document.getElementById('part-time-toggle');
            const remoteWorkToggle = document.getElementById('remote-work-toggle');
            const targetHoursLabel = document.getElementById('target-hours-label');
            const partTimeLabelSpan = document.getElementById('part-time-label');
            const remoteWorkLabelSpan = document.getElementById('remote-work-label');

            const calculateBtn = document.getElementById("calculate-btn");
            const calculateHoursBtn = document.getElementById("calculate-hours-btn");
            const resultCard = document.getElementById("result-card");
            const actualExitCard = document.getElementById("actual-exit-card");
            const inputCard = document.getElementById("input-card");

            // --- Inputs ---
            const entryTimeInput = document.getElementById("entry-time");
            const lunchStartInput = document.getElementById("lunch-start");
            const lunchEndInput = document.getElementById("lunch-end");
            const actualExitTimeInput = document.getElementById("actual-exit-time");

            // --- Intermediate Breaks Elements ---
            const intermediateBreaksContainer = document.getElementById('intermediate-breaks-container');
            const addIntermediateBreakBtn = document.getElementById('add-intermediate-break-btn');
            let intermediateBreakCounter = 0; // To generate unique IDs

            // --- Outputs ---
            const lunchDurationEl = document.getElementById("lunch-duration");
            const lunchBonusEl = document.getElementById("lunch-bonus");
            const exitTimeEl = document.getElementById("exit-time");
            const mealVoucherEl = document.getElementById("meal-voucher-status");
            const totalHoursEl = document.getElementById("total-hours");
            const hoursDifferenceEl = document.getElementById("hours-difference");

            // --- Constants ---
            const FULL_TIME_WORKDAY_MINUTES = 7 * 60 + 12; // 432 minutes
            const PART_TIME_WORKDAY_MINUTES = 6 * 60;      // 360 minutes
            const MIN_LUNCH_BREAK_MINUTES = 30;
            const MAX_LUNCH_BONUS_MINUTES = 10;

            // --- Theme Handling ---
            function setTheme(isDark) {
                document.body.classList.toggle("dark-theme", isDark);
                themeButtonIcon.className = `fas ${isDark ? 'fa-sun' : 'fa-moon'}`;
                themeToggleButton.title = isDark ? "Passa a Tema Chiaro" : "Passa a Tema Scuro";
                localStorage.setItem("darkTheme", isDark ? "true" : "false");
            }
            const savedTheme = localStorage.getItem("darkTheme") === "true";
            setTheme(savedTheme);
            themeToggleButton.addEventListener("click", () => {
                setTheme(!document.body.classList.contains("dark-theme"));
            });

            // --- Rules Section Toggle ---
             rulesToggleButton.addEventListener("click", () => {
                 const isShown = rulesSection.classList.toggle("show");
                 rulesToggleButton.title = isShown ? "Nascondi Regole" : "Mostra Regole";
                 rulesToggleButton.querySelector('.fas').className = `fas ${isShown ? 'fa-times-circle' : 'fa-info-circle'}`;
             });

            // --- Utility Functions ---
            function timeToMinutes(timeStr) {
                if (!timeStr) return null;
                const [hours, minutes] = timeStr.split(":").map(Number);
                if (isNaN(hours) || isNaN(minutes) || hours < 0 || hours > 23 || minutes < 0 || minutes > 59) {
                    return null; // Invalid format or values
                }
                return hours * 60 + minutes;
            }

            function minutesToTimeString(totalMinutes) {
                if (totalMinutes === null || typeof totalMinutes === 'undefined' || isNaN(totalMinutes)) return "--:--";
                const isNegative = totalMinutes < 0;
                const absMinutes = Math.abs(totalMinutes);
                let hours = Math.floor(absMinutes / 60);
                let minutes = Math.round(absMinutes % 60);
                 if (minutes === 60) { // Handle rounding up to next hour
                     hours += 1;
                     minutes = 0;
                 }
                const sign = isNegative ? "-" : "";
                // Pad hours only if non-negative or if negative sign isn't present (e.g. -0 hours)
                const hoursPadding = (sign === "" || hours !== 0) ? 2 : 1;
                return `${sign}${String(hours).padStart(hoursPadding, "0")}:${String(minutes).padStart(2, "0")}`;
            }

            function displayCard(cardElement) {
                 requestAnimationFrame(() => { cardElement.classList.add('show'); });
            }

            function pulseElement(element) {
                if (!element) return;
                element.classList.remove('updated');
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                         element.classList.add('updated');
                         element.addEventListener('animationend', () => {
                             element.classList.remove('updated');
                         }, { once: true });
                    });
                });
            }

            function showAppAlert(message) {
                alert(message); // Simple alert for feedback
            }

             // --- Mode Toggles Handling (Part-Time & Remote) ---
             function updateModeState(changedToggle) {
                 const isPartTime = partTimeToggle.checked;
                 const isRemoteWork = remoteWorkToggle.checked;

                 if (changedToggle === partTimeToggle && isPartTime && isRemoteWork) {
                     remoteWorkToggle.checked = false;
                 } else if (changedToggle === remoteWorkToggle && isRemoteWork && isPartTime) {
                     partTimeToggle.checked = false;
                 }

                 const finalIsPartTime = partTimeToggle.checked;
                 const finalIsRemoteWork = remoteWorkToggle.checked;

                 document.body.classList.toggle('part-time-active', finalIsPartTime);
                 document.body.classList.toggle('remote-work-active', finalIsRemoteWork);

                 let targetLabelText = '';
                 let baseMinutes = FULL_TIME_WORKDAY_MINUTES;
                 if (finalIsPartTime) {
                    baseMinutes = PART_TIME_WORKDAY_MINUTES;
                    targetLabelText = minutesToTimeString(baseMinutes);
                 } else if (finalIsRemoteWork) {
                    baseMinutes = FULL_TIME_WORKDAY_MINUTES; // Remote still uses 7h12m base
                    targetLabelText = minutesToTimeString(baseMinutes) + ' (Remoto)';
                 } else {
                     baseMinutes = FULL_TIME_WORKDAY_MINUTES;
                    targetLabelText = minutesToTimeString(baseMinutes);
                 }
                 targetHoursLabel.textContent = targetLabelText;

                 resultCard.classList.remove('show');
                 actualExitCard.classList.remove('show');
             }

             partTimeToggle.addEventListener('change', () => updateModeState(partTimeToggle));
             remoteWorkToggle.addEventListener('change', () => updateModeState(remoteWorkToggle));
             updateModeState(null); // Initialize on load

             // --- Intermediate Break Handling ---
             function addIntermediateBreakRow() {
                 intermediateBreakCounter++;
                 const rowId = `intermediate-break-${intermediateBreakCounter}`;
                 const startId = `intermediate-start-${intermediateBreakCounter}`;
                 const endId = `intermediate-end-${intermediateBreakCounter}`;

                 const row = document.createElement('div');
                 row.classList.add('intermediate-break-row');
                 row.id = rowId;
                 row.innerHTML = `
                     <div>
                         <label for="${startId}"><i class="fas fa-door-closed"></i>Uscita Intermedia:</label>
                         <input type="time" id="${startId}" class="intermediate-start-input">
                     </div>
                     <div>
                         <label for="${endId}"><i class="fas fa-door-open"></i>Rientro Intermedio:</label>
                         <input type="time" id="${endId}" class="intermediate-end-input">
                     </div>
                     <button type="button" class="remove-intermediate-break-btn" title="Rimuovi questa pausa" data-row-id="${rowId}">
                         <i class="fas fa-trash-alt"></i>
                     </button>
                 `;
                 intermediateBreaksContainer.appendChild(row);
                 // Focus the first input of the new row
                 row.querySelector(`#${startId}`).focus();
             }

             addIntermediateBreakBtn.addEventListener('click', addIntermediateBreakRow);

             // Event delegation for remove buttons
             intermediateBreaksContainer.addEventListener('click', function(event) {
                 const removeButton = event.target.closest('.remove-intermediate-break-btn');
                 if (removeButton) {
                     const rowIdToRemove = removeButton.dataset.rowId;
                     const rowToRemove = document.getElementById(rowIdToRemove);
                     if (rowToRemove) {
                         rowToRemove.remove();
                         // Optional: Recalculate if results are visible? Or just let user recalculate.
                     }
                 }
             });


            // --- Unified Calculation Logic ---
            function calculateTimes() {
                const entryMinutes = timeToMinutes(entryTimeInput.value);
                const lunchStartMinutes = timeToMinutes(lunchStartInput.value);
                const lunchEndMinutes = timeToMinutes(lunchEndInput.value);
                const actualExitMinutes = timeToMinutes(actualExitTimeInput.value);

                const isPartTime = partTimeToggle.checked;
                const isRemoteWork = remoteWorkToggle.checked;
                const targetWorkMinutes = isPartTime ? PART_TIME_WORKDAY_MINUTES : FULL_TIME_WORKDAY_MINUTES;

                // --- Input Validation ---
                if (entryMinutes === null) {
                    showAppAlert("Per favore, inserisci un orario di ingresso valido.");
                    entryTimeInput.focus();
                    return { success: false };
                }

                const hasLunchStart = lunchStartMinutes !== null;
                const hasLunchEnd = lunchEndMinutes !== null;
                let correctedLunchEndMinutes = lunchEndMinutes; // For potential overnight lunch

                if (hasLunchStart && hasLunchEnd) {
                    if (lunchEndMinutes <= lunchStartMinutes) {
                        correctedLunchEndMinutes += (24 * 60); // Assume next day lunch end
                    }
                     // Basic sanity: if end is still before start after adding 24h, something is wrong
                    if (correctedLunchEndMinutes <= lunchStartMinutes) {
                        showAppAlert("L'orario di rientro dalla pausa pranzo non è valido.");
                        lunchEndInput.focus();
                        return { success: false };
                    }
                } else if (hasLunchStart || hasLunchEnd) {
                    showAppAlert("Inserisci sia l'uscita che il rientro per la pausa pranzo, o lasciali entrambi vuoti.");
                    if (hasLunchStart) lunchEndInput.focus(); else lunchStartInput.focus();
                    return { success: false };
                }

                // --- Intermediate Break Calculation & Validation ---
                let totalIntermediateBreakMinutes = 0;
                const intermediateBreaksData = []; // Store validated breaks for later use
                const intermediateBreakRows = intermediateBreaksContainer.querySelectorAll('.intermediate-break-row');
                let intermediateValidationFailed = false;

                for (let i = 0; i < intermediateBreakRows.length; i++) {
                    const row = intermediateBreakRows[i];
                    const startInput = row.querySelector('.intermediate-start-input');
                    const endInput = row.querySelector('.intermediate-end-input');
                    const startMins = timeToMinutes(startInput.value);
                    const endMins = timeToMinutes(endInput.value);

                    if (startMins !== null && endMins !== null) {
                        let correctedEndMins = endMins;
                        if (endMins <= startMins) {
                            correctedEndMins += (24 * 60); // Assume next day return for calculation
                        }

                        if (correctedEndMins <= startMins) {
                            showAppAlert(`Orario di rientro non valido per la pausa intermedia #${i + 1}.`);
                            endInput.focus();
                            intermediateValidationFailed = true;
                            break; // Stop validation on first error
                        }
                        const duration = correctedEndMins - startMins;
                        totalIntermediateBreakMinutes += duration;
                        intermediateBreaksData.push({ start: startMins, end: endMins, correctedEnd: correctedEndMins, duration: duration });
                    } else if (startMins !== null || endMins !== null) {
                        showAppAlert(`Inserisci sia l'uscita che il rientro per la pausa intermedia #${i + 1}, o lasciala vuota.`);
                        if (startMins === null) startInput.focus(); else endInput.focus();
                        intermediateValidationFailed = true;
                        break; // Stop validation on first error
                    }
                    // If both are null, just ignore this row
                }

                if (intermediateValidationFailed) {
                    return { success: false };
                }


                // --- Lunch Break Calculations ---
                let actualLunchDuration = 0;
                let effectiveLunchMinutes = 0; // Min 30 rule for exit time calculation
                let lunchBonusMinutes = 0;
                let mealVoucherEarned = false;

                if (hasLunchStart && hasLunchEnd) {
                    actualLunchDuration = correctedLunchEndMinutes - lunchStartMinutes;
                    effectiveLunchMinutes = Math.max(actualLunchDuration, MIN_LUNCH_BREAK_MINUTES); // At least 30 mins counted towards exit time if break exists
                    if (!isRemoteWork) { // Bonus only applies if not remote
                        lunchBonusMinutes = Math.min(Math.max(0, actualLunchDuration - MIN_LUNCH_BREAK_MINUTES), MAX_LUNCH_BONUS_MINUTES);
                    }
                    // Meal voucher logic based on rules
                    mealVoucherEarned = isRemoteWork ? (actualLunchDuration >= MIN_LUNCH_BREAK_MINUTES) : true;
                }

                // --- Predicted Exit Time ---
                // Base time + Target work + Effective Lunch (min 30) + Intermediate Breaks - Lunch Bonus
                const exitTimeTotalMinutes = entryMinutes + targetWorkMinutes + effectiveLunchMinutes + totalIntermediateBreakMinutes - lunchBonusMinutes;

                // --- Actual Hours Calculation (if actual exit time is provided) ---
                let totalWorkMinutes = null;
                let differenceMinutes = null;

                if (actualExitMinutes !== null) {
                    let grossWorkDurationMinutes = actualExitMinutes - entryMinutes;
                    let normalizedActualExit = actualExitMinutes;

                    // Handle overnight work shift
                    if (actualExitMinutes < entryMinutes) {
                        grossWorkDurationMinutes += 24 * 60;
                        normalizedActualExit += 24 * 60;
                    }

                    // Calculate lunch break duration that falls *within* the work period [entry, exit]
                    let actualLunchBreakDuringWork = 0;
                    if (hasLunchStart && hasLunchEnd) {
                        // Normalize lunch times relative to entry for overlap check
                        let normLunchStart = lunchStartMinutes < entryMinutes ? lunchStartMinutes + 24*60 : lunchStartMinutes;
                        let normLunchEnd = correctedLunchEndMinutes < entryMinutes ? correctedLunchEndMinutes + 24*60 : correctedLunchEndMinutes; // Use corrected (potentially next day) end

                        // Ensure end is after start even with normalization
                        if (normLunchEnd <= normLunchStart) normLunchEnd += 24*60;

                        const breakStartInWork = Math.max(entryMinutes, normLunchStart);
                        const breakEndInWork = Math.min(normalizedActualExit, normLunchEnd);

                        if (breakEndInWork > breakStartInWork) {
                            actualLunchBreakDuringWork = breakEndInWork - breakStartInWork;
                        }
                    }

                    // Calculate intermediate break durations *within* the work period [entry, exit]
                    let totalActualIntermediateBreakDuringWork = 0;
                     intermediateBreaksData.forEach(breakData => {
                         // Normalize intermediate break times relative to entry
                         let normIntermedStart = breakData.start < entryMinutes ? breakData.start + 24*60 : breakData.start;
                         let normIntermedEnd = breakData.correctedEnd < entryMinutes ? breakData.correctedEnd + 24*60 : breakData.correctedEnd;

                         // Ensure end is after start even with normalization
                         if (normIntermedEnd <= normIntermedStart) normIntermedEnd += 24*60;

                         const breakStartInWork = Math.max(entryMinutes, normIntermedStart);
                         const breakEndInWork = Math.min(normalizedActualExit, normIntermedEnd);

                         if (breakEndInWork > breakStartInWork) {
                            totalActualIntermediateBreakDuringWork += (breakEndInWork - breakStartInWork);
                         }
                     });


                    // Total Work = Gross Duration - Actual Lunch during work - Actual Intermediate breaks during work + Lunch Bonus
                    totalWorkMinutes = grossWorkDurationMinutes - actualLunchBreakDuringWork - totalActualIntermediateBreakDuringWork + lunchBonusMinutes;
                    differenceMinutes = totalWorkMinutes - targetWorkMinutes;

                } // end if actualExitMinutes !== null

                // --- Return Results ---
                return {
                    success: true,
                    results: {
                        actualLunchDuration: actualLunchDuration,
                        mealVoucherEarned: mealVoucherEarned,
                        lunchBonusMinutes: lunchBonusMinutes,
                        exitTimeTotalMinutes: exitTimeTotalMinutes,
                        totalWorkMinutes: totalWorkMinutes, // Null if actual exit not provided
                        differenceMinutes: differenceMinutes, // Null if actual exit not provided
                        hasLunch: hasLunchStart && hasLunchEnd,
                        hasActualExit: actualExitMinutes !== null,
                        targetWorkMinutes: targetWorkMinutes,
                        totalIntermediateBreakMinutes: totalIntermediateBreakMinutes // Include this for potential display later if needed
                    }
                };
            }


            // --- Button Event Listeners ---

            calculateBtn.addEventListener("click", function() {
                const calculation = calculateTimes();

                if (calculation.success) {
                    const res = calculation.results;

                    // Update first card (Predicted Exit)
                    lunchDurationEl.textContent = res.hasLunch ? minutesToTimeString(res.actualLunchDuration) : "Nessuna";
                    pulseElement(lunchDurationEl);

                    if (res.hasLunch) {
                        mealVoucherEl.textContent = res.mealVoucherEarned ? "Sì" : "No";
                        mealVoucherEl.className = `result-value ${res.mealVoucherEarned ? 'success' : 'warning'}`;
                    } else {
                        mealVoucherEl.textContent = "N/D";
                        mealVoucherEl.className = "result-value";
                    }
                    pulseElement(mealVoucherEl);

                    lunchBonusEl.textContent = res.lunchBonusMinutes > 0 ? `${res.lunchBonusMinutes} min` : "Nessuno";
                    pulseElement(lunchBonusEl);

                    exitTimeEl.textContent = minutesToTimeString(res.exitTimeTotalMinutes);
                    pulseElement(exitTimeEl);

                    displayCard(resultCard);
                    actualExitCard.classList.remove('show'); // Hide actuals card

                    // Clear previous actual results display
                    totalHoursEl.textContent = "--:--";
                    hoursDifferenceEl.textContent = "--:--";
                    totalHoursEl.className = "result-value";
                    hoursDifferenceEl.className = "result-value";

                } else {
                    // Calculation failed (alert shown inside calculateTimes)
                    resultCard.classList.remove('show');
                    actualExitCard.classList.remove('show');
                }
            });

            calculateHoursBtn.addEventListener("click", function() {
                // Check for actual exit time *before* calling calculate
                if (!actualExitTimeInput.value || timeToMinutes(actualExitTimeInput.value) === null) {
                     showAppAlert("Inserisci un orario effettivo di uscita valido per calcolare le ore lavorate.");
                     actualExitTimeInput.focus();
                     return;
                }

                const calculation = calculateTimes(); // Recalculate everything

                if (calculation.success) {
                    const res = calculation.results;

                     // Update first card (again, for consistency)
                    lunchDurationEl.textContent = res.hasLunch ? minutesToTimeString(res.actualLunchDuration) : "Nessuna";
                     if (res.hasLunch) {
                        mealVoucherEl.textContent = res.mealVoucherEarned ? "Sì" : "No";
                        mealVoucherEl.className = `result-value ${res.mealVoucherEarned ? 'success' : 'warning'}`;
                    } else {
                        mealVoucherEl.textContent = "N/D";
                        mealVoucherEl.className = "result-value";
                    }
                    lunchBonusEl.textContent = res.lunchBonusMinutes > 0 ? `${res.lunchBonusMinutes} min` : "Nessuno";
                    exitTimeEl.textContent = minutesToTimeString(res.exitTimeTotalMinutes);
                    // Pulse first card elements
                    pulseElement(lunchDurationEl);
                    pulseElement(mealVoucherEl);
                    pulseElement(lunchBonusEl);
                    pulseElement(exitTimeEl);


                    // Update second card (Actual Hours)
                    if (res.hasActualExit && res.totalWorkMinutes !== null && res.differenceMinutes !== null) {
                        totalHoursEl.textContent = minutesToTimeString(res.totalWorkMinutes);
                        hoursDifferenceEl.textContent = `${res.differenceMinutes >= 0 ? "+" : ""}${minutesToTimeString(res.differenceMinutes)}`;

                        totalHoursEl.className = "result-value"; // Reset class
                        hoursDifferenceEl.className = "result-value"; // Reset class
                        if (res.differenceMinutes < 0) {
                            //totalHoursEl.classList.add("warning"); // Optional: color total hours
                            hoursDifferenceEl.classList.add("warning");
                        } else if (res.differenceMinutes > 5) { // Threshold for success
                            hoursDifferenceEl.classList.add("success");
                        } else {
                            hoursDifferenceEl.classList.add("info"); // Close enough
                        }

                        pulseElement(totalHoursEl);
                        pulseElement(hoursDifferenceEl);

                        // Show both cards
                        displayCard(resultCard);
                        displayCard(actualExitCard);

                    } else {
                         // Should not happen if initial check passed, but safety fallback
                        showAppAlert("Errore nel calcolo delle ore lavorate. Verifica gli orari inseriti.");
                        actualExitCard.classList.remove('show');
                    }
                } else {
                    // Calculation failed (alert shown inside calculateTimes)
                    resultCard.classList.remove('show');
                    actualExitCard.classList.remove('show');
                }
            });

        });
    </script>
</body>
</html>
